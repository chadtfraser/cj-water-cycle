<!doctype html>
<html>
  <head>
    <title>AR Water Cycle</title>
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <!-- A-Frame (The 3D Engine) -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <!-- AR.js (The Computer Vision for Markers) -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <script>
      // COMPONENT 1: RAIN SYSTEM
      // This creates falling rain drops when active
      AFRAME.registerComponent("rain-system", {
        schema: {
          enabled: { type: "boolean", default: false },
          count: { type: "int", default: 50 },
        },
        init: function () {
          this.drops = [];
          for (let i = 0; i < this.data.count; i++) {
            let drop = document.createElement("a-entity");
            drop.setAttribute("geometry", {
              primitive: "box",
              height: 0.1,
              width: 0.02,
              depth: 0.02,
            });
            drop.setAttribute("material", { color: "#55aaff", shader: "flat" });
            drop.setAttribute("position", this.randomPos());
            drop.setAttribute("visible", false);
            this.el.appendChild(drop);
            this.drops.push({ el: drop, speed: 0.05 + Math.random() * 0.05 });
          }
        },
        randomPos: function () {
          // Spawn rain within the cloud area
          return {
            x: (Math.random() - 0.5) * 1.5,
            y: 0.5 + Math.random() * 0.5,
            z: (Math.random() - 0.5) * 0.8,
          };
        },
        tick: function () {
          if (!this.data.enabled) {
            this.drops.forEach((d) => d.el.setAttribute("visible", false));
            return;
          }

          this.drops.forEach((d) => {
            d.el.setAttribute("visible", true);
            let pos = d.el.getAttribute("position");
            pos.y -= d.speed;

            // Reset rain if it hits the ground
            if (pos.y < -0.5) {
              let newPos = this.randomPos();
              pos.x = newPos.x;
              pos.y = newPos.y;
              pos.z = newPos.z;
            }
            d.el.setAttribute("position", pos);
          });
        },
      });

      // COMPONENT 2: FISH SYSTEM
      // Creates swimming fish that circle around the island
      AFRAME.registerComponent("fish-system", {
        schema: {
          count: { type: "int", default: 10 },
          radius: { type: "number", default: 1.2 },
        },
        init: function () {
          this.fishes = [];
          const colors = [
            "#FF6B35",
            "#F7C548",
            "#FF8C42",
            "#FFD166",
            "#06D6A0",
            "#EF476F",
          ];

          for (let i = 0; i < this.data.count; i++) {
            let fish = document.createElement("a-entity");

            // Fish body
            let body = document.createElement("a-sphere");
            body.setAttribute("scale", "0.05 0.025 0.02");
            body.setAttribute("color", colors[i % colors.length]);
            fish.appendChild(body);

            // Tail
            let tail = document.createElement("a-cone");
            tail.setAttribute("position", "-0.035 0 0");
            tail.setAttribute("rotation", "0 0 90");
            tail.setAttribute("radius-bottom", "0.02");
            tail.setAttribute("height", "0.035");
            tail.setAttribute("color", colors[i % colors.length]);
            fish.appendChild(tail);

            let angle = ((Math.PI * 2) / this.data.count) * i;
            let depth = -0.15 + Math.random() * 0.1;
            let speed = 0.2 + Math.random() * 0.2;

            this.el.appendChild(fish);
            this.fishes.push({
              el: fish,
              angle,
              depth,
              speed,
              radius: this.data.radius * (0.8 + Math.random() * 0.4),
              wobble: Math.random() * Math.PI * 2,
            });
          }
        },
        tick: function (time, timeDelta) {
          const deltaSeconds = timeDelta / 1000;
          this.fishes.forEach((fish) => {
            fish.angle += fish.speed * deltaSeconds;
            fish.wobble += deltaSeconds * 3;

            const x = Math.cos(fish.angle) * fish.radius;
            const z = Math.sin(fish.angle) * fish.radius;
            const y = fish.depth + Math.sin(fish.wobble) * 0.02;

            fish.el.setAttribute("position", { x, y, z });
            const rotY = (-fish.angle * 180) / Math.PI + 90;
            fish.el.setAttribute("rotation", { x: 0, y: rotY, z: 0 });
          });
        },
      });

      // COMPONENT 3: CYCLE ORCHESTRATOR
      // This handles the animation timing (Sun -> Clouds Move -> Rain -> Reset)
      AFRAME.registerComponent("water-cycle-logic", {
        init: function () {
          this.clouds = document.querySelector("#cloud-group");
          this.rain = document.querySelector("#rain-group");
          this.arrows = document.querySelector("#evap-arrows");
          this.label = document.querySelector("#status-label");

          this.timer = 0;
          this.state = "evaporation"; // evaporation, moving, raining
        },
        tick: function (time, timeDelta) {
          this.timer += timeDelta;

          // PHASE 1: Evaporation (0s - 3s)
          if (this.timer < 3000) {
            this.updateState("Evaporation", "red");
            this.arrows.setAttribute("visible", true);
            this.clouds.setAttribute("position", "-1 1.2 0"); // Over water
            this.clouds.setAttribute("scale", "0.5 0.5 0.5"); // Small clouds
            this.rain.setAttribute("rain-system", "enabled: false");
          }
          // PHASE 2: Condensation & Transport (3s - 6s)
          else if (this.timer < 6000) {
            this.updateState("Condensation & Transport", "white");
            this.arrows.setAttribute("visible", false);

            // Lerp clouds from water (-1) to land (1)
            let progress = (this.timer - 3000) / 3000;
            let currentX = -1 + progress * 2;
            let currentScale = 0.5 + progress * 0.5; // Clouds grow

            this.clouds.setAttribute("position", `${currentX} 1.2 0`);
            this.clouds.setAttribute(
              "scale",
              `${currentScale} ${currentScale} ${currentScale}`
            );
          }
          // PHASE 3: Precipitation (6s - 10s)
          else if (this.timer < 10000) {
            this.updateState("Precipitation (Rain)", "blue");
            this.clouds.setAttribute("position", "1 1.2 0"); // Over land
            this.rain.setAttribute("rain-system", "enabled: true");
          }
          // RESET
          else {
            this.timer = 0;
          }
        },
        updateState: function (text, color) {
          this.label.setAttribute("value", text);
          this.label.setAttribute("color", color);
        },
      });
    </script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      .ui-overlay {
        position: fixed;
        bottom: 20px;
        left: 0;
        width: 100%;
        text-align: center;
        color: white;
        font-family: sans-serif;
        font-weight: bold;
        text-shadow: 2px 2px 4px #000;
        z-index: 10;
        pointer-events: none;
      }
    </style>
  </head>

  <body style="margin: 0px; overflow: hidden">
    <div class="ui-overlay">Scan the "HIRO" marker to see the Water Cycle!</div>

    <!-- AR Scene -->
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
      <a-assets timeout="10000">
        <a-asset-item id="tree-model" src="models/tree.glb"></a-asset-item>
      </a-assets>
      <!-- The Marker (HIRO) -->
      <a-marker preset="hiro">
        <!-- MAIN CONTAINER FOR SCALING -->
        <a-entity scale="0.7 0.7 0.7" water-cycle-logic>
          <!-- 1. ISLAND WITH TREES -->
          <a-entity id="land-group" position="0.8 0 0">
            <!-- Sandy beach -->
            <a-cylinder
              position="0 -0.35 0"
              radius="1.1"
              height="0.12"
              color="#d8b384"
              material="shader: flat"></a-cylinder>
            <!-- Grass layer -->
            <a-cylinder
              position="0 -0.25 0"
              radius="1"
              height="0.14"
              color="#3e8c3a"
              material="shader: flat"></a-cylinder>
            <!-- Central mountain -->
            <a-cone
              position="0 0.05 -0.1"
              radius-bottom="0.8"
              height="1.1"
              color="#6b4f3b"
              material="shader: flat"></a-cone>
            <!-- Hills -->
            <a-cone
              position="-0.45 -0.05 0.45"
              radius-bottom="0.45"
              height="0.65"
              color="#4c7a38"
              material="shader: flat"></a-cone>
            <a-cone
              position="0.5 -0.1 0.35"
              radius-bottom="0.38"
              height="0.55"
              color="#3d6a2f"
              material="shader: flat"></a-cone>
            <!-- Trees -->
            <a-entity
              gltf-model="#tree-model"
              scale="0.06 0.06 0.06"
              position="-0.35 0.05 0.55"></a-entity>
            <a-entity
              gltf-model="#tree-model"
              scale="0.05 0.05 0.05"
              position="0.25 0.02 0.6"></a-entity>
            <a-entity
              gltf-model="#tree-model"
              scale="0.045 0.045 0.045"
              position="0.55 -0.06 0.15"></a-entity>
            <a-entity
              gltf-model="#tree-model"
              scale="0.04 0.04 0.04"
              position="-0.05 0.1 0.1"></a-entity>
            <!-- Land label -->
            <a-entity
              position="0 1.5 0"
              text="value: ISLAND; align: center; width: 4; color: white;"></a-entity>
          </a-entity>

          <!-- 2. OCEAN WRAPPING THE ISLAND -->
          <a-entity id="ocean-group" position="0 -0.7 0">
            <a-cylinder
              position="0 0 0"
              radius="2"
              height="0.2"
              color="#0ea5e9"
              material="shader: flat"></a-cylinder>
            <a-cylinder
              position="0 0.12 0"
              radius="2.05"
              height="0.03"
              color="#7dd3fc"
              opacity="0.35"
              material="shader: flat"></a-cylinder>
            <!-- Fish swimming around -->
            <a-entity fish-system="count: 10; radius: 1.4"></a-entity>
            <!-- Ocean label -->
            <a-entity
              position="-1.4 0.5 0"
              text="value: OCEAN; align: center; width: 5; color: white;"></a-entity>
          </a-entity>

          <!-- 3. THE SUN (Yellow Sphere) -->
          <a-sphere
            position="-1.5 2 -1"
            radius="0.4"
            color="#FFD700"
            animation="property: scale; dir: alternate; dur: 1000; to: 1.1 1.1 1.1; loop: true">
          </a-sphere>

          <!-- 4. CLOUDS (Group of white spheres) -->
          <a-entity id="cloud-group" position="-1 1.2 0">
            <a-sphere
              position="0 0 0"
              radius="0.3"
              color="white"
              opacity="0.9"></a-sphere>
            <a-sphere
              position="0.4 0.1 0"
              radius="0.25"
              color="white"
              opacity="0.9"></a-sphere>
            <a-sphere
              position="-0.3 0.1 0.2"
              radius="0.25"
              color="white"
              opacity="0.9"></a-sphere>

            <!-- Rain System Attached to Clouds -->
            <a-entity
              id="rain-group"
              position="0 -0.5 0"
              rain-system="count: 30"></a-entity>
          </a-entity>

          <!-- 5. EVAPORATION (Rising vapor bubbles around ocean) -->
          <a-entity id="evap-arrows" position="0 0 0">
            <a-entity
              position="-0.6 -0.3 0.8"
              geometry="primitive: sphere; radius: 0.035"
              material="color: #cfeafe; transparent: true; opacity: 0.7"
              animation="property: position; to: -0.6 1 0.8; loop: true; dur: 1800; easing: linear"></a-entity>
            <a-entity
              position="-1.1 -0.3 0"
              geometry="primitive: sphere; radius: 0.03"
              material="color: #cfeafe; transparent: true; opacity: 0.6"
              animation="property: position; to: -1.1 1 0; loop: true; dur: 2000; easing: linear; delay: 400"></a-entity>
            <a-entity
              position="-0.4 -0.3 -0.7"
              geometry="primitive: sphere; radius: 0.028"
              material="color: #cfeafe; transparent: true; opacity: 0.6"
              animation="property: position; to: -0.4 1 -0.7; loop: true; dur: 1700; easing: linear; delay: 700"></a-entity>
            <a-entity
              position="0.2 -0.3 1"
              geometry="primitive: sphere; radius: 0.03"
              material="color: #cfeafe; transparent: true; opacity: 0.6"
              animation="property: position; to: 0.2 1 1; loop: true; dur: 2100; easing: linear; delay: 200"></a-entity>
          </a-entity>

          <!-- 6. STATUS TEXT LABEL -->
          <a-text
            id="status-label"
            value="Waiting..."
            position="0 2.5 0"
            align="center"
            width="6"
            color="black"
            side="double"></a-text>
        </a-entity>
      </a-marker>

      <!-- Camera -->
      <a-entity camera></a-entity>
    </a-scene>
  </body>
</html>
